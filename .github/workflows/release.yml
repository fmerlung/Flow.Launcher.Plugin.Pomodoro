name: Build and Release on Tag

on:
  push:
    tags:
      - '*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Publish
        run: dotnet publish -c Release -o ./output

      - name: Zip artifacts
        shell: pwsh
        run: |
          if (Test-Path release.zip) { Remove-Item release.zip }
          Compress-Archive -Path ./output/* -DestinationPath release.zip

      - name: Extract changelog for tag
        id: changelog
        shell: pwsh
        run: |
          $tag = '${{ github.ref_name }}'
          $lines = Get-Content changelog.md -ErrorAction SilentlyContinue
          if (-not $lines) {
            $body = "Release $tag"
          } else {
            $startIdx = $null
            for ($i = 0; $i -lt $lines.Count; $i++) {
              if ($lines[$i] -match "^\s*###\s*(v?$tag)\s*$") { $startIdx = $i; break }
            }
            if ($startIdx -eq $null) {
              $body = "Release $tag"
            } else {
              $j = $startIdx + 1
              $collected = @()
              while ($j -lt $lines.Count -and -not ($lines[$j] -match '^\s*###\s+')) {
                if ($lines[$j].Trim()) { $collected += $lines[$j] }
                $j++
              }
              $body = ($collected -join "`n").Trim()
              if ([string]::IsNullOrWhiteSpace($body)) { $body = "Release $tag" }
            }
          }
          Add-Content -Path $env:GITHUB_OUTPUT -Value "body<<EOF"
          Add-Content -Path $env:GITHUB_OUTPUT -Value $body
          Add-Content -Path $env:GITHUB_OUTPUT -Value "EOF"

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ${{ github.ref_name }}
          body: ${{ steps.changelog.outputs.body }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: release.zip
          asset_name: Pomodoro-${{ github.ref_name }}.zip
          asset_content_type: application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
